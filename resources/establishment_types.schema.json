{
    "$id" : "establishment_types.schema.json",
	"description" : "Describes the entities used in Establishments API; in both the requests and responses.",
	"title" : "ASCWDS Establishment API Schema - Primary Types",
	"definitions" : {
        "id" : {
            "type" : "integer",
            "minimum" : 0
        },
        "uid" : {
            "type" : "string",
            "pattern": "^[0-9A-F]{8}-[0-9A-F]{4}-4[0-9A-F]{3}-[89AB][0-9A-F]{3}-[0-9A-F]{12}$"
        },
        "Username" : {
            "type" : "string",
            "minLength": 3,
            "maxLength": 120
        },
        "Password" : {
            "type" : "string",
            "minLength": 8,
            "maxLength": 120
        },
        "Fullname" : {
            "description" : "The fullname of a user",
            "type" : "string",
            "minLength" : 3,
            "maxLength": 120
        },
        "Address" : {
            "description" : "Concatenated address - excluding postcode",
            "type" : "string",
            "minLength" : 3,
            "maxLength" : 120
        },
        "Postcode" : {
            "description": "A UK postcode",
            "type": "string",
            "pattern" : "([Gg][Ii][Rr] 0[Aa]{2})|((([A-Za-z][0-9]{1,2})|(([A-Za-z][A-Ha-hJ-Yj-y][0-9]{1,2})|(([A-Za-z][0-9][A-Za-z])|([A-Za-z][A-Ha-hJ-Yj-y][0-9][A-Za-z]?))))\s?[0-9][A-Za-z]{2})"
        },
        "LocationRef" : {
            "description" : "A unique reference associated to an Establishment",
            "type" : "string",
            "minLength": 8,
            "maxLength": 12
        },
        "EstablishmentName" : {
            "description": "the name of the Establishment",
            "type" : "string",
            "minLength" : 3,
            "maxLength": 120
        },
        "ServiceName" : {
            "description": "the name of the Service",
            "type" : "string",
            "minLength" : 3,
            "maxLength": 120
        },
        "ServiceCategory" : {
            "description": "the category associated with the Service",
            "type" : "string",
            "minLength" : 3,
            "maxLength": 120
        },
		"EmployerType" : {
			"description" : "The type of employer",
			"type" : "object",
			"properties" : {
				"value" : {
					"description" : "the textual representation of Employer; enumerated because known values",
                    "type" : "string",
                    "enum" : ["Private Sector", "Voluntary or Charity", "Other"]
				},
				"id" : {
					"description" : "Optional integer representing the employer type: 1=Private, 2=Voluntary, 3=Other",
					"$ref" : "#/definitions/ID"
				}
			},
			"required" : ["value"]
        },
        "ServiceCapacity" : {
            "description" : "Optionally associated to a Service, is one or more questions around capacity",
            "type" : "object",
            "properties" : {
                "id": {
                    "description" : "the unique reference of the service capacity",
                    "$ref" : "#/definitions/ID"
                },
                "sequence" : {
                    "description" : "if there is more than one capacity question, this sequence defines the order in which they should be prompted",
                    "type" : "number",
                    "minimum": 1
                },
                "question" : {
                    "description": "The capacity question context",
                    "type" : "string",
                    "minLength" : 3
                },
                "answer" : {
                    "description": "Optional: If a known establishment, the answer to this capacity question",
                    "type" : "integer",
                    "minimum": 0
                }
            }
        },
        "Service" : {
            "description" : "The Service that can be performed at an Establishment",
            "properties" : {
                "id" : {
                    "description" : "the unique reference of the service type",
                    "$ref" : "#/definitions/ID"
                },
                "name" : {
                    "description" : "the display name of the service type",
                    "$ref" : "#/definitions/ServiceName"
                },
                "category" : {
                    "description"  : "the category of this service",
                    "$ref" : "#/definitions/ServiceCategory"
                },
                "isCQC" : {
                    "description": "if true, this service is defined by CQC",
                    "type" : "boolean"
                },
                "isMyService" : {
                    "description" : "optional flag that when true identifies this service being one of the services provided by the Establishment (returned by api/myServices)",
                    "type" : "boolean"
                },
                "capacity" : {
                    "description" : "optional set of capacity questions and, if relevant (associated to a known Establishment), the answers",
                    "type" : "array",
                    "items" : {
                        "$ref" : "#/definitions/ServiceCapacity"
                    },
                    "minItems" : 1
                }
            },
            "required" : ["id"]
        },
        "ServiceGroup" : {
            "description" : "A collection of services having the same cateogory",
            "type" : "object",
            "properties" : {
                "category" : {
                    "$ref" : "#/definitions/ServiceCategory"
                },
                "services" : {
                    "description" : "All the services attributed to this service category",
                    "type" : "array",
                    "items" : {
                        "$ref" : "#/definitions/Service"
                    },
                    "minItems": 1
                }
            }
        },
        "Job" : {
            "description": "An individual job total",
            "type" : "object",
            "properties": {
                "jobId" : {
                    "description" : "A unique reference to the job title",
                    "$ref" : "#/definitions/ID"
                },
                "title" : {
                    "description" : "The title of the job of given jobId",
                    "type" : "string"
                },
                "total" : {
                    "description" : "The number of staff for this specific job (as given by jobId)",
                    "type" : "integer",
                    "minimum": 0,
                    "maximum": 999
                }
            },
            "required" : ["jobId"]
        },
        "Jobs" : {
            "description": "The collective definition of number of vacancies, starters and leavers atytributed to a given establishment. Each is optional, but if given, overwrites all existing jobs of that type",
            "type" : "object",
            "properties" : {
                "Vacancies": {
                    "type" : "array",
                    "items" : [{
                        "$ref" : "#/definitions/Job"
                    }]
                },
                "starters": {
                    "type" : "array",
                    "items" : [{
                        "$ref" : "#/definitions/Job"
                    }]
                },
                "leavers": {
                    "type" : "array",
                    "items" : [{
                        "$ref" : "#/definitions/job"
                    }]
                },
                "TotalVacancies" : {
                    "description" : "The total of all Vacancies - 0, if no Vacancies",
                    "type" : "integer",
                    "minimum": 0
                },
                "TotalStarters" : {
                    "description" : "The total of all Starters - 0, if no Vacancies",
                    "type" : "integer",
                    "minimum": 0
                },
                "TotalLeavers" : {
                    "description" : "The total of all Leavers - 0, if no Vacancies",
                    "type" : "integer",
                    "minimum": 0
                }
            },
            "required" : ["TotalVacancies", "TotalStarters", "TotalLeavers"]
        },
        "LocalAuthority" : {
            "description" : "Local Authority reference",
            "type" : "object",
            "properties" : {
                "id" : {
                    "description" : "This the primary index for a specific Local Authority of a given Establishment",
                    "$ref" : "#/definitions/ID"
                },
                "name" : {
                    "description": "This is the readable name of the Local Authority",
                    "type" : "string",
                    "minLength": 3
                },
                "custodianCode" : {
                    "description" : "A unique reference for a Local Authority",
                    "$ref" : "#/definitions/ID"
                },
                "isPrimaryAuthority" : {
                    "description": "An optional flag (assumed false if not given) that if true, identifies this as being the Local Authority as known by the physical location of the associated Establishment",
                    "type" : "boolean"
                }
            },
            "required" : ["id", "name"]
        },
        "ShareOptions" : {
            "description" : "For sharing data with CQC and Local Authorities",
            "type" : "object",
            "properties" : {
                "enabled" : {
                    "description" : "If false, all sharing is disabled",
                    "type" : "boolean"
                },
                "with" : {
                    "description" : "If enabled is true, describes which of the share options (CQC/Local Authority) is enabled",
                    "type" : "object",
                    "properties": {
                        "shareWithCQC" : {
                            "description": "If true, then share with CQC",
                            "type" : "boolean"
                        },
                        "shareWithLA" : {
                            "description": "If true, then share with Local Authorities"
                        },
                        "authorities" : {
                            "description" : "A list of all the local authorities to which data is shared with; only populated if 'shareWithLA' is true",
                            "type" : "array",
                            "items" : [
                                {
                                    "$ref" : "#/definitions/LocalAuthority"
                                }
                            ]
                        }
                    },
                    "required" : []
                }
            },
            "required" : ["enabled"]
        },
        "ChangeHistory" : {
            "description": "A reverse chronological set of change events. TODO: Add a tighter restriction on required, because before and after are only required when event is changed only, and property only required when event is saved or changed.",
            "type" : "array",
            "items" : [
                {
                    "properties": {
                        "when" : {
                            "description": "The timestamp of the change event",
                            "type" : "date-time"
                        },
                        "event" : {
                            "description": "The event type",
                            "type" : "string",
                            "enum" : ["created", "updated", "saved", "changed"]
                        },
                        "by" : {
                            "description" : "The username of who effected the change event",
                            "type" : "string"
                        },
                        "property" : {
                            "description": "The name of the property which has been changed; this is optional if this history is embedded within a property",
                            "type" : "string"
                        },
                        "before" : {
                            "description" : "The value before the change; any JSON type"
                        },
                        "after" : {
                            "description": "The value after the change; any JSON type"
                        }
                    },
                    "required" : ["when", "event", "by"]
                }
            ]
        },
        "PropertyChangeStatus" : {
            "description": "Used by extended change properties, that can report on their current changd/saved status",
            "properties" : {
                "lastSavedBy" : {
                    "description": "The username of the person who last saved (with or without change) this property",
                    "type" : "string"
                },
                "lastChangedBy" : {
                    "description": "The username of the person who last changed (value change) this property",
                    "type" : "string"
                },
                "lastSaved" : {
                    "description": "The timestamp of when last saved (with or without change) this property",
                    "type" : "string"
                },
                "lastChanged" : {
                    "description": "The timestamp of when last changed (value change) this property",
                    "type" : "string"
                }
            },
            "required" : ["lastSavedBy", "lastChangedBy", "lastSaved", "lastChanged", "changeHistory"]
        },
        "WorkerGender" : {
            "description": "The worker's gender",
            "oneOf": [
                {
                    "description": "Simple Gender type",
                    "type" : "string",
                    "enum" : ["Female", "Male", "Other", "Don't know"]
                },
                {
                    "allOf" : [
                        {
                            "description": "Gender with change history",
                            "type" : "object",
                            "properties": {
                                "currentValue" : {
                                    "type" : "string",
                                    "enum" : ["Female", "Male", "Other", "Don't know"]
                                }
                            },
                            "required" : ["currentValue"]
                        },
                        {
                            "$ref" : "#/definitions/PropertyChangeStatus"
                        }
                    ]
                }
            ]
        },
        "WorkerNameOrId" : {
            "description": "The worker's name/id",
            "oneOf": [
                {
                    "description": "Simple name or id (staff number)",
                    "type"  : "string",
                    "maxLength": 50
                },
                {
                    "allOf" : [
                        {
                            "description": "Name or id with change history",
                            "type" : "object",
                            "properties": {
                                "currentValue" : {
                                    "type"  : "string",
                                    "maxLength": 50
                                }
                            },
                            "required" : ["currentValue"]
                        },
                        {
                            "$ref" : "#/definitions/PropertyChangeStatus"
                        }
                    ]
                }
            ]
        },
        "WorkerContract" : {
            "description": "The worker's contract",
            "oneOf": [
                {
                    "description": "Simple contract",
                    "type" : "string",
                    "enum" : ["Permanent", "Temporary", "Pool/Bank", "Agency", "Other"]
                },
                {
                    "allOf" : [
                        {
                            "description": "Contract with change history",
                            "type" : "object",
                            "properties": {
                                "currentValue" : {
                                    "type" : "string",
                                    "enum" : ["Permanent", "Temporary", "Pool/Bank", "Agency", "Other"]
                                }
                            },
                            "required" : ["currentValue"]
                        },
                        {
                            "$ref" : "#/definitions/PropertyChangeStatus"
                        }
                    ]
                }
            ]
        },
        "WorkerMainJob" : {
            "description": "The worker's contract",
            "oneOf": [
                {
                    "description": "Simple main job",
                    "$ref" : "#/defintions/Job",
                    "required" : ["jobId", "title"]
                },
                {
                    "allOf" : [
                        {
                            "description": "Main job with change history",
                            "type" : "object",
                            "properties": {
                                "currentValue" : {
                                    "$ref" : "#/defintions/Job",
                                    "required" : ["jobId", "title"]
                                }
                            },
                            "required" : ["currentValue"]
                        },
                        {
                            "$ref" : "#/definitions/PropertyChangeStatus"
                        }
                    ]
                }
            ]
        },
        "WorkerApprovedMentalHealthWorker" : {
            "description": "The worker's Approval Mental Health Worker status",
            "oneOf": [
                {
                    "description": "Simple Approval Mental Health Worker status",
                    "type" : "string",
                    "enum" : ["Yes", "No", "Don't know"]
                },
                {
                    "allOf" : [
                        {
                            "description": "Approval Mental Health Worker status with change history",
                            "type" : "object",
                            "properties": {
                                "currentValue" : {
                                    "type" : "string",
                                    "enum" : ["Yes", "No", "Don't know"]
                                }
                            },
                            "required" : ["currentValue"]
                        },
                        {
                            "$ref" : "#/definitions/PropertyChangeStatus"
                        }
                    ]
                }
            ]
        },
        "WorkerMainJobStartDate" : {
            "description": "The worker's Main Job Start Date",
            "oneOf": [
                {
                    "description": "Simple Main Job Start Date",
                    "type" : "string",
                    "pattern": "^[0-9]{4}-[0-9]{2}-[0-9]{2}$"
                },
                {
                    "allOf" : [
                        {
                            "description": "Main Job Start Date with change history",
                            "type" : "object",
                            "properties": {
                                "currentValue" : {
                                    "type" : "string",
                                    "pattern": "^[0-9]{4}-[0-9]{2}-[0-9]{2}$"
                                }
                            },
                            "required" : ["currentValue"]
                        },
                        {
                            "$ref" : "#/definitions/PropertyChangeStatus"
                        }
                    ]
                }
            ]
        },
        "WorkerNationalInsuranceNumber" : {
            "description": "The worker's NI Number",
            "oneOf": [
                {
                    "description": "Simple NI Number",
                    "type" : "string",
                    "pattern" : "[A-Z]{2] [0-9]{2} [0-9]{2} [A-Z]{1}"
                },
                {
                    "allOf" : [
                        {
                            "description": "NI Number with change history",
                            "type" : "object",
                            "properties": {
                                "currentValue" : {
                                    "type" : "string",
                                    "pattern" : "[A-Z]{2] [0-9]{2} [0-9]{2} [A-Z]{1}"
                                }
                            },
                            "required" : ["currentValue"]
                        },
                        {
                            "$ref" : "#/definitions/PropertyChangeStatus"
                        }
                    ]
                }
            ]
        },
        "WorkerDateOfBirth" : {
            "description": "The worker's Date of Birth",
            "oneOf": [
                {
                    "description": "Simple Date of Birth",
                    "type" : "string",
                    "pattern": "^[0-9]{4}-[0-9]{2}-[0-9]{2}$"
                },
                {
                    "allOf" : [
                        {
                            "description": "Date of Birth with change history",
                            "type" : "object",
                            "properties": {
                                "currentValue" : {
                                    "type" : "string",
                                    "pattern": "^[0-9]{4}-[0-9]{2}-[0-9]{2}$"
                                }
                            },
                            "required" : ["currentValue"]
                        },
                        {
                            "$ref" : "#/definitions/PropertyChangeStatus"
                        }
                    ]
                }
            ]
        },
        "WorkerPostcode" : {
            "description": "The worker's Date of Birth",
            "oneOf": [
                {
                    "description": "Simple Date of Birth",
                    "type" : "string",
                    "maxLength": 8
                },
                {
                    "allOf" : [
                        {
                            "description": "Date of Birth with change history",
                            "type" : "object",
                            "properties": {
                                "currentValue" : {
                                    "type" : "string",
                                    "maxLength": 8
                                }
                            },
                            "required" : ["currentValue"]
                        },
                        {
                            "$ref" : "#/definitions/PropertyChangeStatus"
                        }
                    ]
                }
            ]
        },
        "WorkerDisability" : {
            "description": "The worker's Disability",
            "oneOf": [
                {
                    "description": "Simple Disability",
                    "type" : "string",
                    "enum" : ["Yes", "No", "Undisclosed", "Don't know"]
                },
                {
                    "allOf" : [
                        {
                            "description": "Disability with change history",
                            "type" : "object",
                            "properties": {
                                "currentValue" : {
                                    "type" : "string",
                                    "enum" : ["Yes", "No", "Undisclosed", "Don't know"]
                                }
                            },
                            "required" : ["currentValue"]
                        },
                        {
                            "$ref" : "#/definitions/PropertyChangeStatus"
                        }
                    ]
                }
            ]
        },
        "Worker" : {
            "description" : "A Worker belongs to a single Establishment",
            "properties" : {
                "uid" : {
                    "description" : "A unique identifier for a Worker",
                    "$ref" : "#/definitions/uid"
                },
                "nameOrId" : {
                    "description" : "The name or id (staff number) of the worker - unique to the Establishment",
                    "$ref" : "#/definitions/WorkerNameOrId"
                },
                "contract" : {
                    "description": "The employment contract associated to this worker",
                    "$ref" : "#/definitions/WorkerContract"
                },
                "mainJob" : {
                    "description": "The main job/activity associated with this worker; can have other job roles too - see 'otherJobs' below",
                    "$ref" : "#/definitions/WorkerMainJob"
                },
                "approvedMentalHealthWorker" : {
                    "description" : "Only to be used if the main job is or other jobs include, 'social worker'",
                    "type" : "string",
                    "$ref" : "#/definitions/WorkerApprovedMentalHealthWorker"
                },
                "mainJobStartDate" : {
                    "description": "The ISO 8601 format start date attributed to the main job role for this worker; this should be updated if the main job role changes. It's date only (YYYY-MM-DD)",
                    "$ref" : "#/definitions/WorkerMainJobStartDate"
                },
                "nationalInsuranceNumber" : {
                    "description": "National insurance number",
                    "$ref" : "#/definitions/WorkerNationalInsuranceNumber"
                },
                "dateOfBirth" : {
                    "description" : "Date of Birth; YYYY-MM-DD - ISO 8601",
                    "$ref" : "#/definitions/WorkerDateOfBirth"
                },
                "postcode" : {
                    "description" : "Postcode of home address",
                    "$ref" : "#/definitions/WorkerPostcode"
                },
                "gender" : {
                    "description": "The worker's gender",
                    "$ref" : "#/definitions/WorkerGender"
                },
                "disability" : {
                    "description": "The worker's disability",
                    "$ref" : "#/definitions/WorkerDisability"
                },
                "createdAt" : {
                    "description" : "When the worker record was created",
                    "type" : "date-time"
                },
                "updatedAt" : {
                    "description": "When the worker record was last updated",
                    "type" : "date-time"
                },
                "updatedBy" : {
                    "description" : "The username of the last person to update the Worker",
                    "type" : "string"
                },
                "history" : {
                    "$ref" : "#/definitions/ChangeHistory"
                }
            },
            "required" : ["uid", "nameOrId", "contractType", "mainJob", "createdAt", "updatedAt", "updatedBy"]
        },
        "Establishment" : {
            "description" : "A physical location offering care services; can be commercial or private location",
            "type" : "object",
            "properties" : {
                "id" : {
                    "description" : "The unique reference for this estasblishment",
                    "$ref" : "#/definitions/ID"
                },
                "name" : {
                    "description" : "The given name ofthis establishment",
                    "$ref" : "#/definitions/EstablishmentName"
                },
                "address" : {
                    "description": "The given (concatenated) address of this establishment",
                    "$ref" : "#/definitions/Address"
                },
                "postcode" : {
                    "description": "The given postcode of this establishment",
                    "$ref" : "#/definitions/Postcode"
                },
                "locationRef" : {
                    "description": "An optional reference ",
                    "$ref" : "#/definitions/LocationRef"
                },
                "isRegulated" : {
                    "description": "True if this establishment is regulated by CQC",
                    "type": "boolean"
                },
                "mainService" : {
                    "description" : "(Optionally), the primary service associated with this Establishment",
                    "$ref" : "#/definitions/Service"
                },
                "employerType" : {
                    "description": "The type of the employer",
                    "$ref" : "#/definitions/EmployerType"
                },
                "otherServices" : {
                    "description": "Optionally, the establishment can be associated with more than just the main service",
                    "type" : "array",
                    "items" : {
                        "$ref" : "#/definitions/ServiceGroup"
                    }
                },
                "allOtherServices" : {
                    "description": "Optionally, the list of all services available to this Establishment based on CQC (isRegistered), with those services already associated to this Establishment highlighted",
                    "type" : "array",
                    "items" : {
                        "$ref" : "#/definitions/ServiceGroup"
                    }
                },
                "share": {
                    "description" : "Whether to share, and if so, the share options (LA/CQC)",
                    "$ref" : "#/definitions/ShareOptions"
                },
                "numberOfStaff" : {
                    "description" : "The number of staff reported at this Establishment",
                    "type" : "integer",
                    "minimum": 0,
                    "maximum": 999
                },
                "workers" : {
                    "description": "An Establishment has zero or more Workers",
                    "type" : "array",
                    "items" : [
                        { "$ref" : "#/definitions/Worker" }
                    ]
                }
            },
            "required" : ["id", "name"]
        }
    },
    "Feedback" : {
        "description" : "For capturing user feedback",
        "properties" : {
            "id" : {
                "description" : "A unique index for this particular feedback; id is optional because this type is used to both create and return feedback",
                "$ref" : "#/definitions/ID"
            },
            "whenDoing" : {
                "description" : "The feedback as given for 'when doing something in particular'",
                "type" : "string",
                "minLength" : 0,
                "maxLength" : 500
            },
            "tellUs" : {
                "description" : "General 'tell us' feedback",
                "type" : "string",
                "minLength" : 0,
                "maxLength" : 500
            },
            "name" : {
                "description" : "Optional name for the feedback",
                "type" : "string",
                "minLength" : 3,
                "maxLength" : 120
            },
            "email" : {
                "description" : "Optional email for the feedback",
                "type" : "string",
                "minLength" : 3,
                "maxLength" : 120,
                "pattern" : "^(([^<>()\[\]\\.,;:\s@\"]+(\.[^<>()\[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$"
            }
        },
        "required" : ["whenDoing", "tellUs"]
    }
}